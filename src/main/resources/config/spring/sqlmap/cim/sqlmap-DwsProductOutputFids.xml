<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xm.service.dao.cim.DwsProductOutputFidsDAO" >
    <resultMap id="BaseResultMap" type="com.xm.service.apiimpl.pc.cim.outputCompletion.dto.OutputCompletionData$DataList">
        <result column="FACTORY" property="factory" jdbcType="VARCHAR"></result>
        <result column="PLAN_OUTPUT_PNL_QTY" property="plan" jdbcType="DOUBLE"></result>
        <result column="ACTUAL_OUTPUT_PNL_QTY" property="actual" jdbcType="DOUBLE"></result>
        <result column="PERIODDATE" property="periodDate" jdbcType="VARCHAR"></result>
    </resultMap>
    
    <select id="OutputCompletionRate" resultMap="BaseResultMap" parameterType="Map">
        select
            sum(PLAN_OUTPUT_PNL_QTY) as plan,
            sum(ACTUAL_OUTPUT_PNL_QTY) as actual,FACTORY,
            <if test="dateType=='month'.toString()">/*按月*/
                TO_CHAR(PERIODDATE,'MM')||'月'
            </if>
            <if test="dateType=='quarter'.toString()">/*按季度*/
                TO_CHAR(PERIODDATE,'yyyy') ||'年' || TO_CHAR(PERIODDATE,'q') ||'季度'
            </if>
            <if test="dateType=='day'.toString()">/*按天*/
                TO_CHAR(PERIODDATE,'mm/dd')
            </if>
          as periodDate
        from DWS_PRODUCT_OUTPUT_FIDS
        WHERE
            <![CDATA[
               PERIODDATE >= #{beginDate}
              and PERIODDATE <= #{endDate}
             ]]>
        and FACTORY in ('SL','OC')
            <if test="productId!=null and productId!=''">
                AND PRODUCTID=#{productId,jdbcType=VARCHAR}
            </if>
        GROUP BY
            <if test="dateType=='month'.toString()">/*按月*/
            TO_CHAR(PERIODDATE,'MM')||'月',
            </if>
            <if test="dateType=='quarter'.toString()">
                TO_CHAR(PERIODDATE,'yyyy') ||'年' || TO_CHAR(PERIODDATE,'q') ||'季度',
            </if>
            <if test="dateType=='day'.toString()">
                TO_CHAR(PERIODDATE,'mm/dd'),
            </if>
            FACTORY
    </select>

    <select id="loadByPrimaryKey" parameterType="map" resultType="map">
        SELECT * from DWS_PRODUCT_OUTPUT_FIDS
        where FACTORY = #{FACTORY} and
              PRODUCTID = #{PRODUCTID} and
        <if test="PRODUCTTYPE != null">
            PRODUCTTYPE = #{PRODUCTTYPE} and
        </if>
        <if test="PRODUCTTYPE == null">
            PRODUCTTYPE is null and
        </if>
              PERIODDATE = #{PERIODDATE}
    </select>
    <insert id="addData" parameterType="map">
        INSERT INTO  DWS_PRODUCT_OUTPUT_FIDS
        (FACTORY,   PERIODDATE,   PRODUCTTYPE,   PRODUCTID,   PLAN_OUTPUT_PNL_QTY,   ACTUAL_OUTPUT_PNL_QTY,   INTERFACE_TIME) VALUES
        (#{FACTORY},#{PERIODDATE},
        <if test="PRODUCTTYPE == null">
            null
        </if>
        <if test="PRODUCTTYPE != null">
            #{PRODUCTTYPE}
        </if>
        ,#{PRODUCTID},#{PLAN_OUTPUT_PNL_QTY},#{ACTUAL_OUTPUT_PNL_QTY},sysdate)
    </insert>
    <update id="updateData" parameterType="map">
        UPDATE DWS_PRODUCT_OUTPUT_FIDS SET
        PLAN_OUTPUT_PNL_QTY = #{PLAN_OUTPUT_PNL_QTY} ,
        ACTUAL_OUTPUT_PNL_QTY = #{ACTUAL_OUTPUT_PNL_QTY},
        INTERFACE_TIME = sysdate
        WHERE
        FACTORY = #{FACTORY} and
        PERIODDATE = #{PERIODDATE} and
        <if test="PRODUCTTYPE != null">
            PRODUCTTYPE = #{PRODUCTTYPE} and
        </if>
        <if test="PRODUCTTYPE == null">
            PRODUCTTYPE is null and
        </if>
        PRODUCTID = #{PRODUCTID}
    </update>

    <select id="outputDayData" parameterType="map" resultType="com.xm.service.apiimpl.pc.cim.outputCompletion.dto.OutputCollectDataRetDTO$CollectDataList">
        SELECT
        PRODUCTID as productId,
        sum(ACTUAL_OUTPUT_PNL_QTY) as outputNum,
        TO_CHAR(PERIODDATE,'mm/dd') as periodDate
        FROM
        DWS_PRODUCT_OUTPUT_FIDS
        WHERE
        TO_CHAR(PERIODDATE,'dd')=TO_CHAR(sysdate-1,'dd') AND
        PRODUCTID IN
        <foreach collection="productIdList" item="productId" open="(" separator="," close=")" >
            #{productId}
        </foreach>
        GROUP BY PRODUCTID,TO_CHAR(PERIODDATE,'mm/dd')
    </select>

    <select id="outputMonthData" parameterType="map" resultType="com.xm.service.apiimpl.pc.cim.outputCompletion.dto.OutputCollectDataRetDTO$CollectDataList">
        SELECT
        PRODUCTID as productId,
        sum(ACTUAL_OUTPUT_PNL_QTY) as outputNum,
        TO_CHAR(PERIODDATE,'MM')||'月' as periodDate
        FROM
        DWS_PRODUCT_OUTPUT_FIDS
        WHERE
        TO_CHAR(PERIODDATE,'mm')=TO_CHAR(sysdate-1,'mm') AND
        PRODUCTID IN
        <foreach collection="productIdList" item="productId" open="(" separator="," close=")" >
            #{productId}
        </foreach>
        GROUP BY PRODUCTID,TO_CHAR(PERIODDATE,'MM')||'月'
    </select>

</mapper>