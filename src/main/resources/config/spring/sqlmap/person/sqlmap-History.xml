<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xm.service.dao.person.HistoryDAO" >

    <select id="selectFactoryPublicAreaInfos" parameterType="map" resultType="com.xm.service.apiimpl.pc.person.dto.HistoryDTO">
        SELECT a.Param3 as param3,c.Note1 as note1
        FROM [WIN-PAK PRO].[dbo].[History] a
        join [WIN-PAK PRO].[dbo].[CardHolder] c on a.Link3 = c.RecordID
        WHERE a.Link1 IN <foreach collection="cardIds" item="id" open="(" separator="," close=")">
                            #{id}
                        </foreach>
            AND a.TimeStamp > #{beforDate}
            and a.Param1 in (1,2,3,4,5,8,120,124)
            and a.Type1 = 9
            AND a.Param3 IN (


                    SELECT a.Param3 as param3
                    FROM [WIN-PAK PRO].[dbo].[History] a
                    JOIN (
                        SELECT MAX(RecordID) AS maxRecordId, Param3
                        FROM [WIN-PAK PRO].[dbo].[History]
                        WHERE (Link1 IN
                                    <foreach collection="factoryInCardIds" item="inid" open="(" separator="," close=")">
                                        #{inid}
                                    </foreach>

                              OR Link1 IN <foreach collection="factoryOutCardIds" item="outid" open="(" separator="," close=")">
                                        #{outid}
                                    </foreach>
                              )
                        AND TimeStamp > #{beforDate}
                        and Param3 is not null
                        and Param1 in (1,2,3,4,5,8,120,124)
                        and Type1 = 9
                        GROUP BY param3
                    ) b
                    ON a.RecordID = b.maxRecordId
                    AND a.Link1 IN <foreach collection="factoryInCardIds" item="inid" open="(" separator="," close=")">
                            #{inid}
                                 </foreach>

            )
        GROUP BY a.Param3,c.Note1
        HAVING COUNT(*) % 2 = 0

    </select>
    <select id="querySigleIdCards" parameterType="map" resultType="com.xm.service.apiimpl.pc.person.dto.HistoryDTO">
        SELECT a.Param3,c.Note1 as note1, COUNT(*) as num
        FROM [WIN-PAK PRO].[dbo].[History] a
        join [WIN-PAK PRO].[dbo].[CardHolder] c on a.Link3 = c.RecordID
        WHERE a.Link1 IN <foreach collection="cardIds" item="id" open="(" separator="," close=")">
                            #{id}
                        </foreach>
            AND a.TimeStamp > #{beforDate}
            and a.Param3 is not null
            and a.Param1 in (1,2,3,4,5,8,120,124)
            and a.Type1 = 9
        GROUP BY a.Param3,c.Note1
        HAVING COUNT(*) % 2 = 1
    </select>
    <select id="queryLaeastInOutCards" parameterType="map" resultType="com.xm.service.apiimpl.pc.person.dto.HistoryDTO">
        SELECT a.Param3 as param3, a.link1,c.Note1 as note1
        FROM [WIN-PAK PRO].[dbo].[History] a
            JOIN (
                SELECT MAX(RecordID) AS maxRecordId, Param3
                FROM [WIN-PAK PRO].[dbo].[History]
                WHERE (Link1 IN
                              <foreach collection="inIds" item="inid" open="(" separator="," close=")">
                                  #{inid}
                              </foreach>

                        OR Link1 IN <foreach collection="outIds" item="outid" open="(" separator="," close=")">
                                        #{outid}
                                    </foreach>
                      )
                    AND TimeStamp > #{beforDate}
                    and Param3 is not null
                    and Param1 in (1,2,3,4,5,8,120,124)
                    and Type1 = 9
                    GROUP BY param3
            ) b
            ON a.RecordID = b.maxRecordId
                AND a.Link1 IN <foreach collection="inIds" item="inid" open="(" separator="," close=")">
                                #{inid}
                            </foreach>
        join [WIN-PAK PRO].[dbo].[CardHolder] c on a.Link3 = c.RecordID
    </select>

</mapper>